---
import { mockProjects } from '../../lib/mock-data';

const projects = mockProjects;
---

<section id="projects" class="section-padding bg-gradient-to-b from-[var(--color-bg-primary)] to-purple-900/10 relative overflow-hidden">
  <div class="container-custom relative z-10">
    <!-- Section Header -->
    <div class="text-center mb-12 md:mb-20 animate-on-scroll">
      <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4 text-[var(--color-text-primary)]">
        Intelligence, Deployed.
      </h2>
      <p class="text-lg text-[var(--color-text-secondary)] max-w-2xl mx-auto">
        Recent proof of intelligence in the real world
      </p>
    </div>
    
    <!-- Case Studies Vertical Stack -->
    <div class="case-studies-stack">
      {projects.map((project, index) => (
        <article 
          class={`case-study-item ${index % 2 === 0 ? 'align-left' : 'align-right'}`}
          data-index={index}
          data-visual-type={project.visualType}
        >
          <!-- Visual Treatment (Motion-based) -->
          <div class="case-visual">
            {project.visualType === 'warehouse-grid' && (
              <div class="visual-warehouse-grid">
                <div class="grid-row row-1">
                  <div class="grid-item item-1"></div>
                  <div class="grid-item item-2"></div>
                  <div class="grid-item item-3"></div>
                  <div class="grid-item item-4"></div>
                </div>
                <div class="grid-row row-2">
                  <div class="grid-item item-5"></div>
                  <div class="grid-item item-6"></div>
                  <div class="grid-item item-7"></div>
                  <div class="grid-item item-8"></div>
                </div>
                <div class="grid-row row-3">
                  <div class="grid-item item-9"></div>
                  <div class="grid-item item-10"></div>
                  <div class="grid-item item-11"></div>
                  <div class="grid-item item-12"></div>
                </div>
              </div>
            )}
            {project.visualType === 'logistics-flow' && (
              <div class="visual-logistics-flow">
                <div class="flow-stage stage-1">
                  <div class="flow-document doc-1"></div>
                </div>
                <div class="flow-arrow arrow-1"></div>
                <div class="flow-stage stage-2">
                  <div class="flow-document doc-2"></div>
                </div>
                <div class="flow-arrow arrow-2"></div>
                <div class="flow-stage stage-3">
                  <div class="flow-document doc-3"></div>
                </div>
                <div class="flow-arrow arrow-3"></div>
                <div class="flow-stage stage-4">
                  <div class="flow-document doc-4"></div>
                </div>
              </div>
            )}
            {project.visualType === 'document-assembly' && (
              <div class="visual-document-assembly">
                <div class="template-layer layer-base"></div>
                <div class="template-layer layer-content"></div>
                <div class="template-layer layer-approval"></div>
                <div class="template-layer layer-final"></div>
              </div>
            )}
          </div>

          <!-- Content Section -->
          <div class="case-content">
            <!-- Meta (small, muted) -->
            <div class="case-meta">{project.meta}</div>
            
            <!-- Title (Outcome-Driven) -->
            <h3 class="case-title">{project.title}</h3>
            
            <!-- Impact Statement -->
            <p class="case-impact">{project.impact}</p>
          </div>
        </article>
      ))}
    </div>
  </div>
</section>

<style>
  /* ===== CASE STUDIES STACK ===== */
  .case-studies-stack {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 4rem;
  }

  @media (min-width: 1024px) {
    .case-studies-stack {
      gap: 1.5rem;
    }
  }

  /* ===== CASE STUDY ITEM ===== */
  .case-study-item {
    min-height: auto;
    display: flex;
    flex-direction: column;
    position: relative;
    opacity: 1;
    filter: blur(0px);
    transition: opacity 1.2s cubic-bezier(0.16, 1, 0.3, 1),
                filter 1.2s cubic-bezier(0.16, 1, 0.3, 1);
    will-change: opacity, filter;
  }

  .case-study-item.is-active {
    opacity: 1;
    filter: blur(0px);
  }

  .case-study-item.is-inactive {
    opacity: 0.4;
    filter: blur(2px);
  }

  @media (min-width: 1024px) {
    .case-study-item {
      min-height: auto;
      flex-direction: row;
      align-items: center;
      gap: 4rem;
    }

    .case-study-item.align-left {
      flex-direction: row;
    }

    .case-study-item.align-right {
      flex-direction: row-reverse;
    }
  }

  /* ===== VISUAL TREATMENT ===== */
  .case-visual {
    width: 100%;
    height: 30vh;
    min-height: 200px;
    position: relative;
    overflow: hidden;
    border-radius: 1.5rem;
    background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(31, 31, 31, 0.6) 100%);
    border: 1px solid rgba(168, 85, 247, 0.1);
  }

  @media (min-width: 1024px) {
    .case-visual {
      width: 50%;
      height: 45vh;
      min-height: 350px;
    }
  }

  /* ===== WAREHOUSE GRID VISUAL ===== */
  .visual-warehouse-grid {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.75rem;
    padding: 1.5rem;
  }

  .grid-row {
    display: flex;
    gap: 0.75rem;
    width: 100%;
    max-width: 280px;
  }

  .grid-item {
    flex: 1;
    aspect-ratio: 1;
    background: rgba(168, 85, 247, 0.1);
    border: 1px solid rgba(168, 85, 247, 0.2);
    border-radius: 0.375rem;
    animation: itemUpdate 4s ease-in-out infinite;
    position: relative;
    overflow: hidden;
  }

  .grid-item::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      135deg,
      rgba(168, 85, 247, 0.3) 0%,
      rgba(168, 85, 247, 0.1) 100%
    );
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .grid-item:nth-child(odd)::before {
    animation: itemPulse 3s ease-in-out infinite;
  }

  .item-1 { animation-delay: 0s; }
  .item-2 { animation-delay: 0.5s; }
  .item-3 { animation-delay: 1s; }
  .item-4 { animation-delay: 1.5s; }
  .item-5 { animation-delay: 0.3s; }
  .item-6 { animation-delay: 0.8s; }
  .item-7 { animation-delay: 1.3s; }
  .item-8 { animation-delay: 1.8s; }
  .item-9 { animation-delay: 0.6s; }
  .item-10 { animation-delay: 1.1s; }
  .item-11 { animation-delay: 1.6s; }
  .item-12 { animation-delay: 2.1s; }

  @keyframes itemUpdate {
    0%, 100% {
      opacity: 0.4;
      transform: scale(1);
    }
    50% {
      opacity: 0.8;
      transform: scale(1.05);
    }
  }

  @keyframes itemPulse {
    0%, 100% {
      opacity: 0;
    }
    50% {
      opacity: 1;
    }
  }

  /* ===== LOGISTICS FLOW VISUAL ===== */
  .visual-logistics-flow {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 1.5rem;
  }

  .flow-stage {
    position: relative;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .flow-document {
    width: 100%;
    height: 100%;
    background: linear-gradient(
      135deg,
      rgba(168, 85, 247, 0.2) 0%,
      rgba(168, 85, 247, 0.1) 100%
    );
    border: 1.5px solid rgba(168, 85, 247, 0.3);
    border-radius: 0.25rem;
    animation: documentProcess 3s ease-in-out infinite;
    position: relative;
  }

  .flow-document::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(168, 85, 247, 0.4) 50%,
      transparent 100%
    );
    animation: documentShine 2s ease-in-out infinite;
  }

  .doc-1 { animation-delay: 0s; }
  .doc-2 { animation-delay: 0.75s; }
  .doc-3 { animation-delay: 1.5s; }
  .doc-4 { animation-delay: 2.25s; }

  .flow-arrow {
    width: 20px;
    height: 2px;
    background: linear-gradient(
      90deg,
      rgba(168, 85, 247, 0.3) 0%,
      rgba(168, 85, 247, 0.5) 50%,
      rgba(168, 85, 247, 0.3) 100%
    );
    position: relative;
    animation: arrowFlow 2s ease-in-out infinite;
  }

  .flow-arrow::after {
    content: '';
    position: absolute;
    right: -4px;
    top: -3px;
    width: 0;
    height: 0;
    border-left: 6px solid rgba(168, 85, 247, 0.5);
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
  }

  .arrow-1 { animation-delay: 0.3s; }
  .arrow-2 { animation-delay: 1.05s; }
  .arrow-3 { animation-delay: 1.8s; }

  @keyframes documentProcess {
    0%, 100% {
      opacity: 0.5;
      transform: scale(1) translateY(0);
    }
    50% {
      opacity: 1;
      transform: scale(1.1) translateY(-3px);
    }
  }

  @keyframes documentShine {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(200%);
    }
  }

  @keyframes arrowFlow {
    0%, 100% {
      opacity: 0.4;
    }
    50% {
      opacity: 0.8;
    }
  }

  /* ===== DOCUMENT ASSEMBLY VISUAL ===== */
  .visual-document-assembly {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    perspective: 1000px;
  }

  .template-layer {
    position: absolute;
    width: 60%;
    max-width: 200px;
    height: 80px;
    background: linear-gradient(
      135deg,
      rgba(168, 85, 247, 0.15) 0%,
      rgba(168, 85, 247, 0.25) 100%
    );
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 0.375rem;
    animation: layerAssemble 4s ease-in-out infinite;
    box-shadow: 0 2px 8px rgba(168, 85, 247, 0.1);
  }

  .layer-base {
    z-index: 1;
    animation-delay: 0s;
  }

  .layer-content {
    z-index: 2;
    transform: translateY(-10px) rotate(-1deg);
    animation-delay: 0.5s;
  }

  .layer-approval {
    z-index: 3;
    transform: translateY(-20px) rotate(1deg);
    animation-delay: 1s;
  }

  .layer-final {
    z-index: 4;
    transform: translateY(-30px) rotate(-0.5deg);
    animation-delay: 1.5s;
    border-color: rgba(168, 85, 247, 0.5);
    box-shadow: 0 4px 16px rgba(168, 85, 247, 0.2);
  }

  @keyframes layerAssemble {
    0%, 100% {
      opacity: 0.6;
    }
    50% {
      opacity: 1;
    }
  }

  /* ===== CONTENT SECTION ===== */
  .case-content {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 1.5rem;
  }

  @media (min-width: 1024px) {
    .case-content {
      width: 50%;
      margin-top: 0;
    }

    .case-content.align-left {
      text-align: left;
    }

    .case-content.align-right {
      text-align: right;
    }
  }

  /* Meta (small, muted) */
  .case-meta {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  /* Title (Outcome-Driven) */
  .case-title {
    font-size: clamp(2rem, 5vw, 4rem);
    font-weight: 700;
    line-height: 1.1;
    letter-spacing: -0.04em;
    color: var(--color-text-primary);
    margin: 0;
  }

  /* Impact Statement */
  .case-impact {
    font-size: 1.125rem;
    line-height: 1.6;
    color: var(--color-text-secondary);
    margin: 0;
    max-width: 600px;
  }

  @media (min-width: 1024px) {
    .case-content.align-right .case-impact {
      margin-left: auto;
    }
  }

  /* ===== SCROLL ANIMATIONS ===== */
  .animate-on-scroll {
    opacity: 0;
    transform: translateY(48px) scale(0.98);
    transition: opacity 1s cubic-bezier(0.16, 1, 0.3, 1),
                transform 1s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .animate-on-scroll.is-visible {
    opacity: 1;
    transform: translateY(0) scale(1);
  }

  /* ===== REDUCED MOTION ===== */
  @media (prefers-reduced-motion: reduce) {
    .case-study-item,
    .grid-item,
    .flow-document,
    .flow-arrow,
    .template-layer {
      animation: none !important;
      transition: none !important;
    }

    .case-study-item {
      opacity: 1;
      filter: blur(0px);
    }
  }
</style>

<script>
  // ===== SCROLL REVEAL ANIMATIONS =====
  function setupScrollReveals() {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) return;

    const header = document.querySelector('.animate-on-scroll');
    if (header) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
            }
          });
        },
        { threshold: 0.1, rootMargin: '0px 0px -50px 0px' }
      );
      observer.observe(header);
    }
  }

  // ===== ACTIVE PROJECT DETECTION =====
  function setupActiveProjectDetection() {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const caseStudies = document.querySelectorAll('.case-study-item');
    
    if (prefersReducedMotion) {
      // Show all projects clearly if reduced motion
      caseStudies.forEach(item => {
        item.classList.add('is-active');
        item.classList.remove('is-inactive');
      });
      return;
    }

    function updateActiveProject() {
      const viewportHeight = window.innerHeight;
      const viewportCenter = viewportHeight / 2;
      
      let maxVisibility = 0;
      let mostVisible = null;

      caseStudies.forEach(item => {
        const rect = item.getBoundingClientRect();
        const itemTop = rect.top;
        const itemBottom = rect.bottom;
        const itemHeight = rect.height;
        const itemCenter = itemTop + itemHeight / 2;
        
        // Calculate visibility based on how much is in viewport
        const visibleTop = Math.max(0, viewportHeight - itemTop);
        const visibleBottom = Math.max(0, itemBottom);
        const visibleHeight = Math.min(visibleTop, visibleBottom, itemHeight, viewportHeight);
        const visibility = visibleHeight / Math.min(itemHeight, viewportHeight);
        
        // Bonus for being near viewport center
        const distanceFromCenter = Math.abs(itemCenter - viewportCenter);
        const centerBonus = Math.max(0, 1 - (distanceFromCenter / viewportHeight));
        const adjustedVisibility = visibility * 0.7 + centerBonus * 0.3;

        if (adjustedVisibility > maxVisibility && itemTop < viewportHeight && itemBottom > 0) {
          maxVisibility = adjustedVisibility;
          mostVisible = item;
        }
      });

      // Update active state
      caseStudies.forEach(item => {
        if (item === mostVisible && maxVisibility > 0.1) {
          item.classList.add('is-active');
          item.classList.remove('is-inactive');
        } else {
          item.classList.remove('is-active');
          item.classList.add('is-inactive');
        }
      });
    }

    // Initialize on load
    updateActiveProject();
    
    // Update on scroll with throttling
    let ticking = false;
    function onScroll() {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateActiveProject();
          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    
    // Also use IntersectionObserver as backup
    const observer = new IntersectionObserver(
      () => {
        updateActiveProject();
      },
      {
        threshold: [0, 0.1, 0.2, 0.3, 0.5, 0.7, 1],
        rootMargin: '0px'
      }
    );

    caseStudies.forEach(item => {
      observer.observe(item);
    });
  }

  // ===== INITIALIZATION =====
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setupScrollReveals();
      setupActiveProjectDetection();
    });
  } else {
    setupScrollReveals();
    setupActiveProjectDetection();
  }
</script>
